From 562a7220f7b96e251d09bc2026f0daa753ad554c Mon Sep 17 00:00:00 2001
From: Stuart Menefy <stuart.menefy@codasip.com>
Date: Tue, 11 Jun 2024 11:51:09 +0100
Subject: [PATCH 19/19] hw/riscv/hobgoblin: Add support for Codasip timer

Add the new Codasip timer to the Hobgoblin platform.

Signed-off-by: Stuart Menefy <stuart.menefy@codasip.com>
---
 hw/riscv/hobgoblin.c         | 16 ++++++++++++++++
 include/hw/riscv/hobgoblin.h |  3 +++
 2 files changed, 19 insertions(+)

diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index 8b91b41c40..253e4a1d7f 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -87,6 +87,7 @@ static const memmapEntry_t memmap[] = {
     [HOBGOBLIN_SPI] =      { 0x60210000,     0x1000, ""},
     [HOBGOBLIN_GPIO0] =    { 0x60300000,    0x10000, ""},
     [HOBGOBLIN_GPIO1] =    { 0x60310000,    0x10000, ""},
+    [HOBGOBLIN_TIMER] =    { 0x60600000,     0x8000, ""},
     /* Each virtio transport channel uses 512 byte */
     [HOBGOBLIN_VIRTIO] =   { 0x70000000,    0x10000, ""},
     [HOBGOBLIN_DRAM] =     { 0x80000000, 0x40000000,
@@ -406,6 +407,20 @@ static void hobgoblin_add_axi_ethernet(HobgoblinState_t *s)
     s->eth = eth;
 }
 
+/* Codasip Timer at 100 MHz */
+static void hobgoblin_add_timer(HobgoblinState_t *s)
+{
+    SysBusDevice *ss;
+
+    s->timer = qdev_new("codasip,timer");
+    qdev_prop_set_uint32(s->timer, "clock-frequency", 100 * 1000000);
+    ss = SYS_BUS_DEVICE(s->timer);
+    sysbus_realize_and_unref(ss, &error_fatal);
+    sysbus_mmio_map(ss, 0, memmap[HOBGOBLIN_TIMER].base);
+    sysbus_connect_irq(ss, 0,
+                       qdev_get_gpio_in(DEVICE(s->plic), HOBGOBLIN_TIMER_IRQ));
+}
+
 static void hobgoblin_add_virtio(HobgoblinState_t *s)
 {
     const memmapEntry_t *mem_virtio = &memmap[HOBGOBLIN_VIRTIO];
@@ -457,6 +472,7 @@ static void hobgoblin_machine_init(MachineState *machine)
         hobgoblin_add_axi_ethernet(s);
         break;
     }
+    hobgoblin_add_timer(s);
     hobgoblin_add_virtio(s);
 
     /* load images into memory to boot the platform */
diff --git a/include/hw/riscv/hobgoblin.h b/include/hw/riscv/hobgoblin.h
index 3477701120..2a5603c077 100644
--- a/include/hw/riscv/hobgoblin.h
+++ b/include/hw/riscv/hobgoblin.h
@@ -48,6 +48,7 @@ typedef struct {
     DeviceState *spi;
     DeviceState *gpio[2];
     DeviceState *eth;
+    DeviceState *timer;
 } HobgoblinState_t;
 
 #define HOBGOBLIN_MACHINE_STATE(obj) \
@@ -67,6 +68,7 @@ enum {
     HOBGOBLIN_SPI,
     HOBGOBLIN_GPIO0,
     HOBGOBLIN_GPIO1,
+    HOBGOBLIN_TIMER,
     HOBGOBLIN_VIRTIO,
     HOBGOBLIN_DRAM
 };
@@ -79,6 +81,7 @@ enum {
     HOBGOBLIN_SPI_IRQ      = 4,
     HOBGOBLIN_GPIO0_IRQ    = 7,
     HOBGOBLIN_GPIO1_IRQ    = 8,
+    HOBGOBLIN_TIMER_IRQ    = 9,
     HOBGOBLIN_ETH_IRQ      = 15,
     HOBGOBLIN_AXIDMA_IRQ0  = 16,
     HOBGOBLIN_AXIDMA_IRQ1  = 17,
-- 
2.43.0

