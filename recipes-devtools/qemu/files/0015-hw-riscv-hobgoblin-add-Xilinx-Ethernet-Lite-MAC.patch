From c673b0d1d23d5fd1facd47911dd4dd157b338dbd Mon Sep 17 00:00:00 2001
From: Stuart Menefy <stuart.menefy@codasip.com>
Date: Tue, 19 Mar 2024 17:27:25 +0000
Subject: [PATCH 15/17] hw/riscv/hobgoblin: add Xilinx Ethernet Lite MAC

---
 hw/riscv/Kconfig             |  1 +
 hw/riscv/hobgoblin.c         | 17 +++++++++++++++++
 include/hw/riscv/hobgoblin.h |  2 ++
 3 files changed, 20 insertions(+)

diff --git a/hw/riscv/Kconfig b/hw/riscv/Kconfig
index e17fe84d8a..99e0e95be4 100644
--- a/hw/riscv/Kconfig
+++ b/hw/riscv/Kconfig
@@ -92,3 +92,4 @@ config HOBGOBLIN
     select SIFIVE_PLIC
     select XILINX_SPI
     select XILINX_AXI_GPIO
+    select XILINX_ETHLITE
diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index 4f7d9f93bb..8a359b8429 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -48,9 +48,11 @@
 #include "sysemu/qtest.h"
 #include "sysemu/sysemu.h"
 #include "exec/address-spaces.h"
+#include "net/net.h"
 
 #define TYPE_XILINX_SPI "xlnx.xps-spi"
 #define TYPE_XLNX_AXI_GPIO "xlnx.axi-gpio"
+#define TYPE_XILINX_ETHLITE "xlnx.xps-ethernetlite"
 
 static const struct MemmapEntry {
     hwaddr base;
@@ -62,6 +64,7 @@ static const struct MemmapEntry {
     [HOBGOBLIN_SRAM] =     { 0x20000000, 0x08000000 },
     [HOBGOBLIN_PLIC] =     { 0x40000000,  0x4000000 },
     [HOBGOBLIN_CLINT] =    { 0x60014000,     0xc000 },
+    [HOBGOBLIN_ETH] =      { 0x60020000,     0x2000 },
     [HOBGOBLIN_UART0] =    { 0x60100000,     0x1020 },
     [HOBGOBLIN_SPI] =      { 0x60210000,     0x1000 },
     [HOBGOBLIN_GPIO0] =    { 0x60300000,    0x10000 },
@@ -86,6 +89,7 @@ static const struct MemmapEntry {
 #define HOBGOBLIN_SPI_IRQ       4
 #define HOBGOBLIN_GPIO0_IRQ     7
 #define HOBGOBLIN_GPIO1_IRQ     8
+#define HOBGOBLIN_ETH_IRQ       15
 #define HOBGOBLIN_VIRTIO_IRQ    28 /* to 31 */
 
 /* CLINT timebase frequency */
@@ -208,6 +212,19 @@ static void hobgoblin_board_init(MachineState *machine)
                                                 HOBGOBLIN_GPIO0_IRQ + i));
     }
 
+    /* Ethernet (ethernetlite) */
+    qemu_check_nic_model(&nd_table[0], TYPE_XILINX_ETHLITE);
+    s->eth = qdev_new(TYPE_XILINX_ETHLITE);
+    qdev_set_nic_properties(s->eth, &nd_table[0]);
+    //qdev_prop_set_uint32(s->eth, "tx-ping-pong", 0x1000); this defaults to 1
+    //qdev_prop_set_uint32(s->eth, "rx-ping-pong", 0x1000);
+    ss = SYS_BUS_DEVICE(s->eth);
+    sysbus_realize_and_unref(ss, &error_fatal);
+    sysbus_mmio_map(ss, 0, memmap[HOBGOBLIN_ETH].base);
+    sysbus_connect_irq(ss, 0,
+                       qdev_get_gpio_in(DEVICE(s->plic), HOBGOBLIN_ETH_IRQ));
+
+    /* Reset */
     qdev_connect_gpio_out(DEVICE(s->gpio[1]), 3,
                           qemu_allocate_irq(hobgoblin_machine_reset, NULL, 0));
 
diff --git a/include/hw/riscv/hobgoblin.h b/include/hw/riscv/hobgoblin.h
index 69d62868f3..897f8a1a5a 100644
--- a/include/hw/riscv/hobgoblin.h
+++ b/include/hw/riscv/hobgoblin.h
@@ -37,6 +37,7 @@ typedef struct {
     DeviceState *plic;
     DeviceState *spi;
     DeviceState *gpio[2];
+    DeviceState *eth;
 } HobgoblinState;
 
 enum {
@@ -46,6 +47,7 @@ enum {
     HOBGOBLIN_SRAM,
     HOBGOBLIN_PLIC,
     HOBGOBLIN_CLINT,
+    HOBGOBLIN_ETH,
     HOBGOBLIN_UART0,
     HOBGOBLIN_SPI,
     HOBGOBLIN_GPIO0,
-- 
2.39.3

