From f27595749e1bfb06fee608252c3f53a7965cd92b Mon Sep 17 00:00:00 2001
From: Axel Heider <axel.heider@codasip.com>
Date: Tue, 19 Mar 2024 15:57:16 +0000
Subject: [PATCH 08/15] hw/riscv/hobgoblin: add gpio-restart

Co-authored-by: Samuel Obuch <samuel.obuch@codasip.com>
Signed-off-by: Axel Heider <axel.heider@codasip.com>
---
 hw/riscv/hobgoblin.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index 64b31c65d3..0187098240 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -28,6 +28,7 @@
 #include "qemu/error-report.h"
 #include "qapi/error.h"
 #include "hw/boards.h"
+#include "hw/irq.h"
 #include "hw/loader.h"
 #include "hw/sysbus.h"
 #include "hw/sd/sd.h"
@@ -44,6 +45,7 @@
 #include "sysemu/device_tree.h"
 #include "sysemu/qtest.h"
 #include "sysemu/sysemu.h"
+#include "sysemu/runstate.h"
 #include "exec/address-spaces.h"
 
 #define TYPE_XILINX_SPI "xlnx.xps-spi"
@@ -252,6 +254,14 @@ static void hobgoblin_add_uart(HobgoblinState_t *s,
                    chardev, DEVICE_LITTLE_ENDIAN);
 }
 
+static void hobgoblin_gpio_1_3_event(void *opaque, int n, int level)
+{
+    /* gpio pin active high triggers reset */
+    if (level) {
+        qemu_system_reset_request(SHUTDOWN_CAUSE_GUEST_RESET);
+    }
+}
+
 static void hobgoblin_add_gpio(HobgoblinState_t *s)
 {
     for (int i = 0; i < 2; i++) {
@@ -265,6 +275,11 @@ static void hobgoblin_add_gpio(HobgoblinState_t *s)
         /* publish GPIO device */
         s->gpio[i] = gpio;
     }
+
+    /* Reset via GPIO 1.3 */
+    qdev_connect_gpio_out(DEVICE(s->gpio[1]), 3,
+                          qemu_allocate_irq(hobgoblin_gpio_1_3_event, NULL, 0));
+
 }
 
 static void hobgoblin_add_spi(HobgoblinState_t *s)
-- 
2.39.3

