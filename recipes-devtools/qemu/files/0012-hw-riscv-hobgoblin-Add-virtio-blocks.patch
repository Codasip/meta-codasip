From e85afa2f0bb939d9e95557b78046496ed7b1b484 Mon Sep 17 00:00:00 2001
From: Stuart Menefy <stuart.menefy@codasip.com>
Date: Wed, 15 May 2024 16:48:50 +0100
Subject: [PATCH 12/17] hw/riscv/hobgoblin: Add virtio blocks

Add four virtio blocks so that various virtual IO devices can be
added.

Co-authored-by: Stuart Menefy <stuart.menefy@codasip.com>
Signed-off-by: Axel Heider <axel.heider@codasip.com>
---
 hw/riscv/hobgoblin.c         | 15 +++++++++++++++
 include/hw/riscv/hobgoblin.h |  4 ++++
 2 files changed, 19 insertions(+)

diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index 4982799f43..f54d3cb895 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -83,6 +83,8 @@ static const memmapEntry_t memmap[] = {
     [HOBGOBLIN_SPI] =      { 0x60210000,     0x1000, ""},
     [HOBGOBLIN_GPIO0] =    { 0x60300000,    0x10000, ""},
     [HOBGOBLIN_GPIO1] =    { 0x60310000,    0x10000, ""},
+    /* Each virtio transport channel uses 512 byte */
+    [HOBGOBLIN_VIRTIO] =   { 0x70000000,    0x10000, ""},
     [HOBGOBLIN_DRAM] =     { 0x80000000, 0x40000000,
         "riscv.hobgoblin.ram"},
 };
@@ -338,6 +340,18 @@ static void hobgoblin_add_eth(HobgoblinState_t *s)
     s->eth = eth;
 }
 
+static void hobgoblin_add_virtio(HobgoblinState_t *s)
+{
+    const memmapEntry_t *mem_virtio = &memmap[HOBGOBLIN_VIRTIO];
+
+    for (int i = 0; i < NUM_VIRTIO_TRANSPORTS; i++) {
+        hwaddr offset = 0x200 * i;
+        assert(offset < mem_virtio->size);
+        hwaddr base = mem_virtio->base + offset;
+        qemu_irq irq = hobgoblin_make_plic_irq(s, HOBGOBLIN_VIRTIO_IRQ + i);
+        sysbus_create_simple("virtio-mmio", base, irq);
+    }
+}
 
 static void hobgoblin_machine_init(MachineState *machine)
 {
@@ -366,6 +380,7 @@ static void hobgoblin_machine_init(MachineState *machine)
     hobgoblin_add_gpio(s);
     hobgoblin_add_spi(s);
     hobgoblin_add_eth(s);
+    hobgoblin_add_virtio(s);
 
     /* load images into memory to boot the platform */
     int ret = hobgoblin_load_images(machine, s);
diff --git a/include/hw/riscv/hobgoblin.h b/include/hw/riscv/hobgoblin.h
index b82f6142f3..fd504d9619 100644
--- a/include/hw/riscv/hobgoblin.h
+++ b/include/hw/riscv/hobgoblin.h
@@ -53,9 +53,12 @@ enum {
     HOBGOBLIN_SPI,
     HOBGOBLIN_GPIO0,
     HOBGOBLIN_GPIO1,
+    HOBGOBLIN_VIRTIO,
     HOBGOBLIN_DRAM
 };
 
+#define NUM_VIRTIO_TRANSPORTS   4
+
 enum {
     /* Interrupt 0 is reserved */
     HOBGOBLIN_UART0_IRQ    = 1,
@@ -63,6 +66,7 @@ enum {
     HOBGOBLIN_GPIO0_IRQ    = 7,
     HOBGOBLIN_GPIO1_IRQ    = 8,
     HOBGOBLIN_ETH_IRQ      = 15,
+    HOBGOBLIN_VIRTIO_IRQ = 28, /* to 31 */
     /* ----------- */
     HOBGOBLIN_MAX_IRQ
 };
-- 
2.39.3

