From 67b7d2e5d0f137f19750965e50bf31660bfc2e15 Mon Sep 17 00:00:00 2001
From: Samuel Obuch <samuel.obuch@codasip.com>
Date: Mon, 4 Mar 2024 09:03:14 +0100
Subject: [PATCH 14/17] hw/riscv/hobgoblin: add gpio-restart

Enables reboot command from linux
---
 hw/riscv/hobgoblin.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index 8472603dac..6e10bf62a8 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -28,6 +28,7 @@
 #include "qemu/error-report.h"
 #include "qapi/error.h"
 #include "hw/boards.h"
+#include "hw/irq.h"
 #include "hw/loader.h"
 #include "hw/sysbus.h"
 #include "hw/misc/unimp.h"
@@ -89,6 +90,14 @@ static const struct MemmapEntry {
 /* CLINT timebase frequency */
 #define CLINT_TIMEBASE_FREQ 100000000
 
+static void hobgoblin_machine_reset(void *opaque, int n, int level)
+{
+    /* gpio pin active high triggers reset */
+    if (level) {
+        qemu_system_reset_request(SHUTDOWN_CAUSE_GUEST_RESET);
+    }
+}
+
 static void hobgoblin_board_init(MachineState *machine)
 {
     const struct MemmapEntry *memmap = hobgoblin_memmap;
@@ -198,6 +207,9 @@ static void hobgoblin_board_init(MachineState *machine)
                                                 HOBGOBLIN_GPIO0_IRQ + i));
     }
 
+    qdev_connect_gpio_out(DEVICE(s->gpio[1]), 3,
+                          qemu_allocate_irq(hobgoblin_machine_reset, NULL, 0));
+
     /* VirtIO */
     for (i = 0; i < NUM_VIRTIO_TRANSPORTS; i++) {
         sysbus_create_simple("virtio-mmio", memmap[HOBGOBLIN_VIRTIO].base + 0x200 * i,
-- 
2.39.3

