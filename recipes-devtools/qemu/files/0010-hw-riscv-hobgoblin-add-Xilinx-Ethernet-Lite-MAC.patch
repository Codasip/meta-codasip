From 42902f8c7a0757975ef2a68db46f6d8f7ae20060 Mon Sep 17 00:00:00 2001
From: Axel Heider <axel.heider@codasip.com>
Date: Wed, 20 Mar 2024 19:45:33 +0000
Subject: [PATCH 10/17] hw/riscv/hobgoblin: add Xilinx Ethernet Lite MAC

Co-authored-by: Stuart Menefy <stuart.menefy@codasip.com>
Signed-off-by: Axel Heider <axel.heider@codasip.com>
---
 hw/riscv/Kconfig             |  1 +
 hw/riscv/hobgoblin.c         | 27 +++++++++++++++++++++++++++
 include/hw/riscv/hobgoblin.h |  3 +++
 3 files changed, 31 insertions(+)

diff --git a/hw/riscv/Kconfig b/hw/riscv/Kconfig
index e17fe84d8a..99e0e95be4 100644
--- a/hw/riscv/Kconfig
+++ b/hw/riscv/Kconfig
@@ -92,3 +92,4 @@ config HOBGOBLIN
     select SIFIVE_PLIC
     select XILINX_SPI
     select XILINX_AXI_GPIO
+    select XILINX_ETHLITE
diff --git a/hw/riscv/hobgoblin.c b/hw/riscv/hobgoblin.c
index f6c3e67b75..4982799f43 100644
--- a/hw/riscv/hobgoblin.c
+++ b/hw/riscv/hobgoblin.c
@@ -47,9 +47,11 @@
 #include "sysemu/sysemu.h"
 #include "sysemu/runstate.h"
 #include "exec/address-spaces.h"
+#include "net/net.h"
 
 #define TYPE_XILINX_SPI "xlnx.xps-spi"
 #define TYPE_XLNX_AXI_GPIO "xlnx.axi-gpio"
+#define TYPE_XILINX_ETHLITE "xlnx.xps-ethernetlite"
 
 typedef struct {
     hwaddr base;
@@ -68,6 +70,7 @@ static const memmapEntry_t memmap[] = {
         "riscv.hobgoblin.sram"},
     [HOBGOBLIN_PLIC] =     { 0x40000000,  0x4000000, ""},
     [HOBGOBLIN_CLINT] =    { 0x60014000,     0xc000, ""},
+    [HOBGOBLIN_ETH] =      { 0x60020000,     0x2000, ""},
     /*
      * The Hobgoblin FPGA uses a Xilinx AXI UART 16550 v2.0, which is at
      * 0x60100000 and uses 8 KiB in the address space. However, the lower 4 KiB
@@ -313,6 +316,29 @@ static void hobgoblin_add_spi(HobgoblinState_t *s)
     s->spi = spi;
 }
 
+static void hobgoblin_add_eth(HobgoblinState_t *s)
+{
+    const memmapEntry_t *mem_eth = &memmap[HOBGOBLIN_ETH];
+
+    NICInfo *nd = &nd_table[0];
+    const char *model = TYPE_XILINX_ETHLITE;
+
+    /* Ethernet (ethernetlite) */
+    qemu_check_nic_model(nd, model);
+    DeviceState *eth = qdev_new(model);
+    qdev_set_nic_properties(eth, nd);
+
+    SysBusDevice *bus_eth = SYS_BUS_DEVICE(eth);
+    sysbus_realize_and_unref(bus_eth, &error_fatal);
+    sysbus_mmio_map(bus_eth, 0, mem_eth->base);
+    /* connect PLIC interrupt */
+    hobgoblin_connect_plic_irq(s, bus_eth, HOBGOBLIN_ETH_IRQ);
+
+    /* publish ETH device */
+    s->eth = eth;
+}
+
+
 static void hobgoblin_machine_init(MachineState *machine)
 {
     HobgoblinState_t *s = HOBGOBLIN_MACHINE_STATE(machine);
@@ -339,6 +365,7 @@ static void hobgoblin_machine_init(MachineState *machine)
     hobgoblin_add_uart(s, system_memory);
     hobgoblin_add_gpio(s);
     hobgoblin_add_spi(s);
+    hobgoblin_add_eth(s);
 
     /* load images into memory to boot the platform */
     int ret = hobgoblin_load_images(machine, s);
diff --git a/include/hw/riscv/hobgoblin.h b/include/hw/riscv/hobgoblin.h
index aab4a80f13..b82f6142f3 100644
--- a/include/hw/riscv/hobgoblin.h
+++ b/include/hw/riscv/hobgoblin.h
@@ -35,6 +35,7 @@ typedef struct {
     DeviceState *plic;
     DeviceState *spi;
     DeviceState *gpio[2];
+    DeviceState *eth;
 } HobgoblinState_t;
 
 #define HOBGOBLIN_MACHINE_STATE(obj) \
@@ -47,6 +48,7 @@ enum {
     HOBGOBLIN_SRAM, /* exists on FPGA only */
     HOBGOBLIN_PLIC,
     HOBGOBLIN_CLINT,
+    HOBGOBLIN_ETH,
     HOBGOBLIN_UART0,
     HOBGOBLIN_SPI,
     HOBGOBLIN_GPIO0,
@@ -60,6 +62,7 @@ enum {
     HOBGOBLIN_SPI_IRQ      = 4,
     HOBGOBLIN_GPIO0_IRQ    = 7,
     HOBGOBLIN_GPIO1_IRQ    = 8,
+    HOBGOBLIN_ETH_IRQ      = 15,
     /* ----------- */
     HOBGOBLIN_MAX_IRQ
 };
-- 
2.39.3

